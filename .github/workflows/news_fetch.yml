# .github/workflows/news_fetch.yml á€€á€­á€¯ á€¡á€±á€¬á€€á€ºá€•á€«á€¡á€á€­á€¯á€„á€ºá€¸ á€œá€¯á€¶á€¸á€ á€¡á€…á€¬á€¸á€‘á€­á€¯á€¸á€›á€”á€º

name: Fetch and Save News by Category

on:
  schedule:
    # ğŸ“Œ á€™á€¼á€”á€ºá€™á€¬á€…á€¶á€á€±á€¬á€ºá€á€»á€­á€”á€º (MMT - UTC+6:30) á€€á€­á€¯ á€¡á€á€¼á€±á€á€¶á€á€±á€¬ á… á€€á€¼á€­á€™á€º
    - cron: "30 1 * * *" # 01:30 UTC = 8:00 AM MMT (General)
    - cron: "30 5 * * *" # 05:30 UTC = 12:00 PM MMT (Technology)
    - cron: "30 9 * * *" # 09:30 UTC = 4:00 PM MMT (World Politics)
    - cron: "30 13 * * *" # 13:30 UTC = 8:00 PM MMT (Business and Finance)
    - cron: "30 16 * * *" # 16:30 UTC = 11:00 PM MMT (Daily Summary)
  workflow_dispatch:

jobs:
  run-news-fetcher:
    runs-on: ubuntu-latest

    # ğŸ“Œ FIX 1: Log file á€€á€­á€¯ Repository á€á€­á€¯á€· Commit á€œá€¯á€•á€ºá€›á€”á€ºá€¡á€á€½á€€á€º Permission
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install requests gspread

      - name: Determine Category and Run Script
        id: run_script_step
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: |
          # á€œá€€á€ºá€›á€¾á€­ UTC á€”á€¬á€›á€®á€€á€­á€¯ á€šá€°á€á€¼á€„á€ºá€¸ (GitHub Actions á€›á€²á€· default time zone)
          CURRENT_HOUR=$(date -u +%H) 

          # Schedule á€¡á€œá€­á€¯á€€á€º Category á€á€á€ºá€™á€¾á€á€ºá€á€¼á€„á€ºá€¸
          if [ "$CURRENT_HOUR" == "01" ]; then
            CATEGORY="General" 
          elif [ "$CURRENT_HOUR" == "05" ]; then
            CATEGORY="Technology" 
          elif [ "$CURRENT_HOUR" == "09" ]; then
            CATEGORY="World Politics" 
          elif [ "$CURRENT_HOUR" == "13" ]; then
            CATEGORY="Business and Finance" 
          elif [ "$CURRENT_HOUR" == "16" ]; then
            CATEGORY="Daily Summary" 
          else
            CATEGORY="General" 
          fi

          echo "CATEGORY=$CATEGORY" >> $GITHUB_OUTPUT 
          LOG_FILE="logs/run_${{ github.run_id }}_${CATEGORY}.log" 

          mkdir -p logs

          # Log file á€‘á€²á€á€­á€¯á€· output á€¡á€¬á€¸á€œá€¯á€¶á€¸á€€á€­á€¯ Redirect á€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
          echo "--- Workflow Run Start: $(date) ---" > $LOG_FILE
          echo "Running news fetcher for category: $CATEGORY" >> $LOG_FILE
          # Python Script Output (stdout á€”á€¾á€„á€·á€º stderr á€”á€¾á€…á€ºá€á€¯á€œá€¯á€¶á€¸) á€€á€­á€¯ Log á€‘á€²á€á€­á€¯á€· á€‘á€Šá€·á€ºá€á€¼á€„á€ºá€¸
          python news_fetcher.py "$CATEGORY" >> $LOG_FILE 2>&1
          echo "Workflow execution log saved to $LOG_FILE" >> $LOG_FILE

      - name: Commit and Push Log File
        # Run Failure á€–á€¼á€…á€ºá€á€²á€·á€›á€„á€ºá€á€±á€¬á€„á€º Log á€€á€­á€¯ Commit á€œá€¯á€•á€ºá€”á€­á€¯á€„á€ºá€›á€”á€º
        if: always()
        run: |
          LOG_FILE="logs/run_${{ github.run_id }}_${{ steps.run_script_step.outputs.CATEGORY }}.log"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -f "$LOG_FILE" ]; then
            git add $LOG_FILE
            
            # Log file add á€•á€¼á€®á€¸á€”á€±á€¬á€€á€ºáŠ á€€á€»á€”á€ºá€›á€¾á€­á€á€±á€¬ changes á€™á€»á€¬á€¸á€€á€­á€¯ á€›á€¾á€„á€ºá€¸á€œá€„á€ºá€¸á€›á€”á€º
            if [ -n "$(git status --porcelain)" ]; then
              # Index á€™á€¾á€¬á€™á€•á€«á€á€±á€¸á€á€²á€· changes á€á€½á€±á€›á€¾á€­á€›á€„á€º á€•á€¼á€”á€ºá€†á€½á€²á€‘á€¯á€á€ºá€œá€­á€¯á€€á€ºá€á€šá€º
              git checkout .
            fi
            
            # ğŸ“Œ FIX: Push Rejected Error á€€á€­á€¯ á€–á€¼á€±á€›á€¾á€„á€ºá€¸á€›á€”á€ºáŠ Commit á€™á€œá€¯á€•á€ºá€á€„á€º Remote Changes á€™á€»á€¬á€¸á€€á€­á€¯ á€†á€½á€²á€šá€°á€á€¼á€„á€ºá€¸
            git pull --rebase origin main 
            
            if git diff --cached --exit-code; then
              echo "No changes in $LOG_FILE to commit."
            else
              git commit -m "Workflow: Save log for run ${{ github.run_id }} (${{ steps.run_script_step.outputs.CATEGORY }})"
              echo "Pushing log file to repository..."
              git push 
            fi
          else
            echo "Log file $LOG_FILE not found, skipping commit."
          fi
